@using Nbugs.Common
@{
    ViewBag.Title = "角色授权设置";
    Layout = "~/Views/Shared/_Index_Layout.cshtml";
}

<div class="mvctool">
    <a id="btnSave" style="float: left;" class="l-btn l-btn-plain">
        <span class="l-btn-left">
            <span class="l-btn-text icon-save" style="padding-left: 20px;">保存</span>
        </span>
    </a>
</div>
<table style="width: 100%">
    <tbody>
        <tr>
            <td style="width: 420px; padding-right: 3px; vertical-align: top">
                <table id="roleList"></table>
            </td>
            <td style="width: 200px; padding-right: 3px; vertical-align: top">
                <table id="moduleList"></table>
            </td>
            <td>
                <table id="operateList"></table>
            </td>
        </tr>
    </tbody>
</table>

<script type="text/javascript">
    $(function () {
        var curModuleId, curRoleId, curModuleName, curRoleName;
        //选择的模块ID,选中的角色ID，选中的模块名称，角色名称
        curModuleId = -1;
        curRoleId = -1;
        curRoleName = "?";
        curModuleName = "?";
        $('#roleList').datagrid({
            url: '@Url.Action("GetRoleList")',
            loadMsg: '加载中，请等待...',
            width: 420,
            methord: 'post',
            height: $(window).height() - 35,
            fitColumns: true,
            sortName: 'Id',
            sortOrder: 'desc',
            idField: 'Id',
            pagination: false,
            striped: true, //奇偶行是否区分
            singleSelect: true,//单选模式
            rownumbers: true,//行号
            title: '角色列表',
            columns: [[
                { field: 'Id', title: '', width: 80, hidden: true },
                { field: 'Name', title: '角色', width: 80, sortable: true },
            ]],
            onClickRow: function (index, data) {
                var row = $('#roleList').datagrid('getSelected');
                if (row != null) {
                    curRoleName = row.Name;
                    curRoleId = row.Id;
                    if (curModuleId == -1) {
                        //$.messageBox5s('提示', "请再选择最后菜单项！");
                        $('#operateList').datagrid({
                            'title': "角色: " + curRoleName + " >> 模块：" + curModuleName
                        });
                        return false;
                    }
                    else {
                        $('#operateList').datagrid({
                            title: "角色: " + curRoleName + " >> 模块：" + curModuleName,
                            url: "/RoleModule/GetRoleModuleActions?roleId=" + curRoleId + "&moduleId=" + curModuleId + ""
                        });
                    }
                }
            }
        });
        $('#moduleList').treegrid({
            url: '@Url.Action("GetModuleList")',
            width: 300,
            methord: 'post',
            height: $(window).height() - 35,
            fitColumns: true,
            treeField: 'Name',
            idField: 'Id',
            pagination: false,
            striped: true, //奇偶行是否区分
            singleSelect: true,//单选模式
            title: '模块列表',
            columns: [[
                { field: 'Id', title: '唯一标识', hidden: true },
                { field: 'Name', title: '名称', width: 220 },
                { field: 'IsLast', title: '是否最后一项', hidden: true },
            ]],
            onClickRow: function (index, data) {
                var row = $('#moduleList').treegrid('getSelected');
                if (row != null) {
                    curModuleName = row.Name;
                    curModuleId = row.Id;
                    if (curRoleId == -1) {
                        $.messageBox5s('提示', "请再选择一个角色！");
                        return false;
                    }
                    if (!row.IsLast) {
                        $('#operateList').datagrid({
                            'title': "角色组: " + curRoleName + " >> 模块：" + (row.IsLast ? curModuleName : "[请再选择最后菜单项]")
                        });
                        return false;
                    }
                    $('#operateList').datagrid({
                        title: "角色组: " + curRoleName + " >> 模块：" + (row.IsLast ? curModuleName : "[请再选择最后菜单项]"),
                        url: "/RoleModule/GetRoleModuleActions?roleId=" + curRoleId + "&moduleId=" + curModuleId + ""
                    });
                }

            }
        });
        $('#operateList').datagrid({
            url: '@Url.Action("GetRoleModuleActions")',
            loadMsg: '加载中，请等待...',
            width: $(window).width() - 736,
            methord: 'post',
            height: $(window).height() - 35,
            fitColumns: true,
            sortOrder: 'desc',
            idField: 'KeyCode',
            striped: true, //奇偶行是否区分
            singleSelect: true,//单选模式
            title: '授权操作',
            //rownumbers: true,//行号
            columns: [[
                { field: 'Name', title: '名称', width: 80, sortable: true },
                { field: 'KeyCode', title: '操作码', width: 80, sortable: true },
                {
                    field: 'IsValid', title: '选择权限', width: 80, formatter: function (value) {
                        if (value) {
                            return "<input type='checkbox' checked='checked' value=" + value + " />";
                        } else {
                            return "<input type='checkbox' value=" + value + " />";
                        }
                    }
                },
                { field: 'ModuleId', title: '模块ID', hidden: true },
                { field: 'RoleId', title: '角色Id', hidden: true }
            ]]
        });
        $("#btnSave").click(function () {
            var updateRows = 0;
            var rows = $("#operateList").datagrid("getRows"); //这段代码是获取当前页的所有行。
            for (var i = 0; i < rows.length; i++) {
                var setFlag = $("td[field='IsValid'] input").eq(i).prop("checked");
                if (rows[i].IsValid != setFlag)//判断是否有作修改
                {
                    $.post("@Url.Action("UpdateRight")", {
                        "RoleModuleId": rows[i].RoleModuleId,
                        "KeyCode": rows[i].KeyCode,
                        "IsValid": setFlag,
                        "RoleId": rows[i].RoleId,
                        "ModuleId": rows[i].ModuleId
                    });
                    updateRows++;
                }
            }
            if (updateRows > 0) {
                $.messageBox5s('提示', '@Suggestion.UpdateSucceed');
            } else {
                $.messageBox5s('提示', '@Suggestion.NoAnyChanges');
            }

        });
        $(window).resize(function () {
            $('#operateList').datagrid('resize', {
                width: $(window).width() - 736,
                height: $(window).height() - 35
            }).datagrid('resize', {
                width: $(window).width() - 736,
                height: $(window).height() - 35
            });
            $('#moduleList,#roleList').datagrid('resize', {
                height: $(window).height() - 35
            }).datagrid('resize', {
                height: $(window).height() - 35
            });
        });
    });

    function SelAll() {
        $("td[field='IsValid'] input").prop("checked", true);
        $("#btnSave").trigger("click");
        return;
    }
    function UnSelAll() {
        $("td[field='IsValid'] input").prop("checked", false);
        $("#btnSave").trigger("click");
        return;
    }
</script>